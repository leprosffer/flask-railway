{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Mon espace</h2>
    <p class="text-center">Budget actuel : <strong>{{ budget }} €</strong></p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" class="row g-3">
        <input type="hidden" name="action" value="set_budget">
        <div class="col-md-4">
            <label class="form-label">Nouveau budget :</label>
            <input type="number" name="new_budget" class="form-control" required>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary">Définir</button>
        </div>
    </form>

    <hr>

    <form method="POST" class="row g-3">
        <input type="hidden" name="action" value="add_depense">
        <div class="col-md-3">
            <label class="form-label">Montant dépensé :</label>
            <input type="number" name="depense_montant" step="0.01" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label">Catégorie :</label>
            <input type="text" name="depense_categorie" class="form-control" required>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-warning">Ajouter dépense</button>
        </div>
    </form>

    <hr>

    <form method="POST" class="row g-3">
        <input type="hidden" name="action" value="add_economie">
        <div class="col-md-3">
            <label class="form-label">Économie :</label>
            <input type="number" name="economie_montant" step="0.01" class="form-control" required>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-success">Économiser</button>
        </div>
    </form>

    <form method="POST" class="row g-3 mt-2">
        <input type="hidden" name="action" value="remove_economie">
        <div class="col-md-3">
            <label class="form-label">Retirer économie :</label>
            <input type="number" name="economie_montant" step="0.01" class="form-control" required>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-danger">Retirer</button>
        </div>
    </form>

    <hr>

    <form method="POST" class="row g-3">
        <input type="hidden" name="action" value="add_investissement">
        <div class="col-md-3">
            <label class="form-label">Montant investi :</label>
            <input type="number" name="investissement_montant" step="0.01" class="form-control" required>
        </div>
        <div class="col-md-3">
            <label class="form-label">Domaine :</label>
            <input type="text" name="investissement_domaine" class="form-control" required>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-info">Investir</button>
        </div>
    </form>

    <hr>

    <div class="mt-4">
        <label for="courbe_select" class="form-label">Choisir un graphique :</label>
        <select id="courbe_select" class="form-select mb-3">
            <option value="depense_chart">Dépenses</option>
            <option value="economie_chart">Économies</option>
            <option value="investissement_chart">Investissements</option>
        </select>

        <canvas id="depense_chart" height="100"></canvas>
        <canvas id="economie_chart" height="100" style="display: none;"></canvas>
        <canvas id="investissement_chart" height="100" style="display: none;"></canvas>
    </div>
</div>

<script>
    const depenses = {{ depenses|tojson }};
    const economies = {{ economies|tojson }};
    const investissements = {{ investissements|tojson }};

    const ctx1 = document.getElementById('depense_chart').getContext('2d');
    const ctx2 = document.getElementById('economie_chart').getContext('2d');
    const ctx3 = document.getElementById('investissement_chart').getContext('2d');

    const depenseChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: depenses.map(d => d[2]),
            datasets: [{
                label: 'Dépenses (€)',
                data: depenses.map(d => d[0]),
                backgroundColor: 'rgba(255, 99, 132, 0.5)'
            }]
        }
    });

    const economieChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: economies.map(e => e[1]),
            datasets: [{
                label: 'Économies (€)',
                data: economies.map(e => e[0]),
                backgroundColor: 'rgba(75, 192, 192, 0.5)'
            }]
        }
    });

    const investissementChart = new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: investissements.map(i => i[2]),
            datasets: [{
                label: 'Investissements (€)',
                data: investissements.map(i => i[0]),
                backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }]
        }
    });

    document.getElementById('courbe_select').addEventListener('change', function () {
        const selected = this.value;
        document.getElementById('depense_chart').style.display = selected === 'depense_chart' ? 'block' : 'none';
        document.getElementById('economie_chart').style.display = selected === 'economie_chart' ? 'block' : 'none';
        document.getElementById('investissement_chart').style.display = selected === 'investissement_chart' ? 'block' : 'none';
    });
</script>
{% endblock %}